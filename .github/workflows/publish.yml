name: Publish Skills Registry

on:
  push:
    paths:
      - 'skills/**'
      - 'scripts/generate-index.py'
      - 'scripts/generate-readme.py'
      - 'scripts/count-tokens.py'
      - 'scripts/check-duplicates.py'
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  publish:
    name: Regenerate Registry Metadata
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install tiktoken pyyaml

      - name: Generate index.json
        run: |
          python3 scripts/generate-index.py -o skills/index.json --pretty
          echo "Generated index.json"
          python3 -c "
          import json
          with open('skills/index.json') as f:
              idx = json.load(f)
          print(f'  Skills: {idx[\"skills_count\"]}')
          print(f'  Categories: {len(idx[\"categories\"])}')
          "

      - name: Generate search-index.json
        run: |
          # search-index.json will be generated by scripts/generate-search-index.py
          # when feature #10 is implemented. For now, derive a lightweight version
          # from index.json for basic client-side search.
          python3 -c "
          import json
          with open('skills/index.json') as f:
              idx = json.load(f)
          search = []
          for key, skill in idx['skills'].items():
              search.append({
                  'name': skill['name'],
                  'description': skill.get('description', ''),
                  'category': skill.get('category', ''),
                  'tier': skill.get('tier', 0),
                  'tokens': skill.get('token_counts', {}).get('total', 0),
                  'source': skill.get('source', ''),
                  'tags': skill.get('metadata', {}).get('tags', []),
              })
          with open('skills/search-index.json', 'w') as f:
              json.dump(search, f, indent=2, ensure_ascii=False)
              f.write('\n')
          print(f'Generated search-index.json: {len(search)} entries')
          "

      - name: Generate README.md
        run: |
          python3 scripts/generate-readme.py
          echo "Generated skills/README.md"

      - name: Generate badges
        run: |
          # Badge generation will be handled by scripts/generate-badges.py
          # when feature #8 is implemented. Create badges/ directory as placeholder.
          mkdir -p skills/badges
          echo "Badge generation placeholder (feature #8)"

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add skills/index.json skills/search-index.json skills/README.md skills/badges/
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: regenerate skills registry metadata

          Auto-generated by publish workflow after merge to main.
          "
            git push
            echo "Committed and pushed updated metadata"
          fi
